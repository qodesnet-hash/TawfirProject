server {
    server_name tawfir.app www.tawfir.app api.tawfir.app 164.92.132.225;
    client_max_body_size 10M;
    
    # ========================================
    # Static Files - Images/CSS/JS (الأولوية)
    # ========================================
    location /static/images/ {
        alias /var/www/html/static/images/;
        
        location ~* \.(php|py|sh|exe)$ {
            deny all;
            return 404;
        }
        
        location ~* \.(jpg|jpeg|png|gif|svg|webp|ico)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff";
            access_log off;
        }
        
        autoindex off;
    }
    
    location /static/css/ {
        alias /var/www/html/static/css/;
        expires 7d;
        add_header Cache-Control "public, must-revalidate";
        access_log off;
    }
    
    location /static/js/ {
        alias /var/www/html/static/js/;
        expires 7d;
        add_header Cache-Control "public, must-revalidate";
        access_log off;
    }
    
    # ========================================
    # Django Static Files (Backend)
    # ========================================
    location /static/ {
        alias /opt/TawfirProject/backend/staticfiles/;
        expires 7d;
        add_header Cache-Control "public";
    }
    
    # ========================================
    # Media Files (User Uploads)
    # ========================================
    location /media/ {
        alias /opt/TawfirProject/backend/media/;
        expires 30d;
        add_header Cache-Control "public";
    }
    
    # ========================================
    # Special Files
    # ========================================
    location = /favicon.ico { 
        access_log off; 
        log_not_found off; 
    }
    
    location /google-signin.html {
        alias /var/www/html/google-signin.html;
    }
    
    location = /privacy-policy {
        default_type text/html;
        alias /var/www/tawfir/static/privacy-policy.html;
    }
    
    # ========================================
    # API - No Cache for Logout
    # ========================================
    location /api/v1/auth/logout/ {
        include proxy_params;
        proxy_pass http://unix:/opt/TawfirProject/backend/gunicorn.sock;
        proxy_buffering off;
        proxy_cache off;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    }
    
    # ========================================
    # Default API Proxy
    # ========================================
    location / {
        include proxy_params;
        proxy_pass http://unix:/opt/TawfirProject/backend/gunicorn.sock;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
        expires 0;
    }
    
    # ========================================
    # SSL Configuration
    # ========================================
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/tawfir.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tawfir.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# ========================================
# HTTP to HTTPS Redirect
# ========================================
server {
    listen 80;
    server_name tawfir.app www.tawfir.app api.tawfir.app 164.92.132.225;
    
    if ($host = api.tawfir.app) {
        return 301 https://$host$request_uri;
    }
    
    if ($host = www.tawfir.app) {
        return 301 https://$host$request_uri;
    }
    
    if ($host = tawfir.app) {
        return 301 https://$host$request_uri;
    }
    
    return 404;
}
